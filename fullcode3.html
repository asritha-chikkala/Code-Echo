<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #prompt {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
        }
        #generateButton {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 0 auto 20px;
        }
        #generateButton:hover {
            background-color: #45a049;
        }
        #responseOutput {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            font-family: monospace;
            overflow-x: auto;
        }
        .loading {
            text-align: center;
            display: none;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        #copyButton {
            background-color: #2196F3;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }
        #copyButton:hover {
            background-color: #0b7dda;
        }
        .syntax-highlight {
            background-color: #f0f0f0;
            border-left: 3px solid #2196F3;
            padding-left: 10px;
        }
        .history-panel {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            display: none;
        }
        .history-title {
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .history-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item:hover {
            background-color: #e0e0e0;
        }
        .history-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .history-button {
            background-color: #607d8b;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .history-button:hover {
            background-color: #455a64;
        }
        #seeHistoryBtn {
            background-color: #673AB7;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            display: block;
        }
        #seeHistoryBtn:hover {
            background-color: #5E35B1;
        }
    </style>
</head>
<body>
    <h1>Code Generation</h1>
    
    <textarea id="prompt" placeholder="Enter your prompt for code generation here..."></textarea>
    
    <div class="controls">
        <button id="generateButton">Generate Code</button>
        <button id="copyButton">Copy Code</button>
    </div>
    
    <div class="loading" id="loadingIndicator">
        <p>Generating code...</p>
    </div>
    
    <div id="responseOutput"></div>
    
    <!-- Button to show/hide history -->
    <button id="seeHistoryBtn">See History</button>
    
    <!-- Stack panel (initially hidden) -->
    <div id="historyPanel" class="history-panel">
        <h3 class="history-title">Recent History</h3>
        <div id="stackItems"></div>
        <div class="history-controls">
            <button id="clearStackBtn" class="history-button">Clear History</button>
            <button id="saveStackBtn" class="history-button">Save History</button>
        </div>
    </div>

    <script>
        // API key hardcoded directly in code - never do this in production!
        const apiKey = "oo5bTTZ0WMzzjZ2AnrX6udkvKlwyncjL6FC5SnnT";
        
        class HistoryStack {
            constructor(maxSize = 10) {
                this.items = [];
                this.maxSize = maxSize;
            }
            push(item) {
                this.items.unshift(item);
                if (this.items.length > this.maxSize) {
                    this.items.pop();
                }
                this.saveToLocalStorage();
            }
            pop() {
                if (this.isEmpty()) return null;
                const item = this.items.shift();
                this.saveToLocalStorage();
                return item;
            }
            peek() {
                if (this.isEmpty()) return null;
                return this.items[0];
            }
            isEmpty() {
                return this.items.length === 0;
            }
            clear() {
                this.items = [];
                this.saveToLocalStorage();
            }
            getItems() {
                return [...this.items];
            }
            saveToLocalStorage() {
                localStorage.setItem('codeGenerationHistory', JSON.stringify(this.items));
            }
            loadFromLocalStorage() {
                const saved = localStorage.getItem('codeGenerationHistory');
                if (saved) {
                    try {
                        this.items = JSON.parse(saved);
                    } catch (e) {
                        console.error("Failed to parse history from localStorage", e);
                        this.items = [];
                    }
                }
            }
        }
        
        const historyStack = new HistoryStack(10);
        historyStack.loadFromLocalStorage();
        
        document.getElementById('seeHistoryBtn').addEventListener('click', function() {
            const historyPanel = document.getElementById('historyPanel');
            if (historyPanel.style.display === 'block') {
                historyPanel.style.display = 'none';
                this.textContent = 'See History';
            } else {
                historyPanel.style.display = 'block';
                this.textContent = 'Hide History';
                updateStackDisplay();
            }
        });
        
        document.getElementById('generateButton').addEventListener('click', async function() {
            const prompt = document.getElementById('prompt').value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const responseOutput = document.getElementById('responseOutput');
            const copyButton = document.getElementById('copyButton');

            if (!prompt || prompt.trim().length === 0) {
                alert('Please enter a prompt');
                return;
            }

            // Ensure the prompt is substantial enough for the API
            const trimmedPrompt = prompt.trim();
            if (trimmedPrompt.length < 3) {
                alert('Please enter a more detailed prompt (at least 3 characters)');
                return;
            }

            loadingIndicator.style.display = 'block';
            responseOutput.textContent = '';
            copyButton.style.display = 'none';

            const requestData = {
                model: "command-a-03-2025",
                messages: [
                    {
                        role: "user",
                        content: trimmedPrompt + " (Please provide only code as output, no explanations)"
                    }
                ]
            };

            try {
                const response = await fetch('https://api.cohere.ai/v2/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestData),
                });

                loadingIndicator.style.display = 'none';

                if (response.ok) {
                    const responseData = await response.json();
                    const generatedText = responseData.message.content[0].text;

                    const formattedCode = formatCodeOutput(generatedText);
                    responseOutput.innerHTML = formattedCode;

                    copyButton.style.display = 'block';

                    const newItem = {
                        id: Date.now().toString(),
                        prompt: prompt,
                        code: generatedText,
                        timestamp: new Date().toISOString()
                    };

                    historyStack.push(newItem);

                    if (document.getElementById('historyPanel').style.display === 'block') {
                        updateStackDisplay();
                    }
                } else {
                    const errorData = await response.json();
                    responseOutput.textContent = `Error: ${errorData.message || JSON.stringify(errorData)}`;
                }
            } catch (error) {
                loadingIndicator.style.display = 'none';
                responseOutput.textContent = `Error: ${error.message}`;
            }
        });

        document.getElementById('copyButton').addEventListener('click', function() {
            const responseOutput = document.getElementById('responseOutput');
            const textArea = document.createElement('textarea');
            textArea.value = responseOutput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = 'Copy Code';
            }, 2000);
        });

        function formatCodeOutput(code) {
            let cleanCode = code.trim();
            cleanCode = cleanCode.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            const keywords = [
                "function", "return", "if", "else", "for", "while", "var", "let", 
                "const", "class", "import", "export", "from", "async", "await", 
                "try", "catch", "finally"
            ];
            
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'g');
                cleanCode = cleanCode.replace(regex, `<span style="color: blue;">${keyword}</span>`);
            });
            
            return `<div class="syntax-highlight">${cleanCode}</div>`;
        }
        
        function updateStackDisplay() {
            const stackItems = document.getElementById('stackItems');
            stackItems.innerHTML = '';
            const items = historyStack.getItems();
            if (items.length === 0) {
                stackItems.innerHTML = '<p>No history items yet</p>';
                return;
            }
            items.forEach((item) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                const date = new Date(item.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                const truncatedPrompt = item.prompt.length > 40 
                    ? item.prompt.substring(0, 40) + '...' 
                    : item.prompt;
                historyItem.textContent = `${formattedDate}: ${truncatedPrompt}`;
                historyItem.title = item.prompt;

                historyItem.addEventListener('click', () => {
                    document.getElementById('prompt').value = item.prompt;
                    const responseOutput = document.getElementById('responseOutput');
                    responseOutput.innerHTML = formatCodeOutput(item.code);
                    document.getElementById('copyButton').style.display = 'block';
                });
                stackItems.appendChild(historyItem);
            });
        }
        
        document.getElementById('clearStackBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all history?')) {
                historyStack.clear();
                updateStackDisplay();
            }
        });

        document.getElementById('saveStackBtn').addEventListener('click', function() {
            const items = historyStack.getItems();
            if (items.length === 0) {
                alert('No history items to save');
                return;
            }
            let historyText = '# Cohere AI Code Generation History\n\n';
            items.forEach((item, index) => {
                const date = new Date(item.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                historyText += `## ${index + 1}. ${formattedDate}\n\n`;
                historyText += `### Prompt\n${item.prompt}\n\n`;
                historyText += `### Generated Code\n\n${item.code}\n\n`;
                historyText += '---\n\n';
            });
            const element = document.createElement('a');
            const file = new Blob([historyText], {type: 'text/markdown'});
            element.href = URL.createObjectURL(file);
            element.download = 'code-generation-history.md';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        });

    </script>
</body>
</html>